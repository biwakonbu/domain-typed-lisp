name: extension-release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "検証対象タグ（例: v0.2.0）"
        required: true
        type: string

permissions:
  contents: read

jobs:
  preflight:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: verify tag and extension version match
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            RAW_TAG="${{ github.event.inputs.tag }}"
          else
            RAW_TAG="${GITHUB_REF_NAME}"
          fi
          if [[ ! "$RAW_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "tag must match v<major>.<minor>.<patch>: $RAW_TAG"
            exit 1
          fi
          TAG_VERSION="${RAW_TAG#v}"
          PKG_VERSION="$(jq -r '.version' editors/vscode-dtl/package.json)"
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "tag version (v$TAG_VERSION) and editors/vscode-dtl/package.json version ($PKG_VERSION) must match"
            exit 1
          fi
      - name: generate syntax assets
        run: |
          bun install --cwd tooling/dtl-syntax
          bun run --cwd tooling/dtl-syntax generate
      - name: package extension
        run: |
          bun install --cwd editors/vscode-dtl
          bun run --cwd editors/vscode-dtl package
      - name: upload vsix artifact
        uses: actions/upload-artifact@v4
        with:
          name: vscode-dtl-vsix
          path: editors/vscode-dtl/dtl-*.vsix

  publish-marketplace:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: preflight
    env:
      VSCE_PAT: ${{ secrets.VSCE_PAT }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: skip marketplace publish when secret is absent
        if: env.VSCE_PAT == ''
        run: echo "VSCE_PAT is not set; skip VS Code Marketplace publish"
      - name: publish to VS Code Marketplace
        if: env.VSCE_PAT != ''
        run: |
          bun install --cwd editors/vscode-dtl
          bunx --cwd editors/vscode-dtl @vscode/vsce publish --no-dependencies -p "$VSCE_PAT"

  publish-openvsx:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: preflight
    env:
      OVSX_PAT: ${{ secrets.OVSX_PAT }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: skip Open VSX publish when secret is absent
        if: env.OVSX_PAT == ''
        run: echo "OVSX_PAT is not set; skip Open VSX publish"
      - name: publish to Open VSX
        if: env.OVSX_PAT != ''
        run: |
          bun install --cwd editors/vscode-dtl
          bunx --cwd editors/vscode-dtl ovsx publish --pat "$OVSX_PAT"
